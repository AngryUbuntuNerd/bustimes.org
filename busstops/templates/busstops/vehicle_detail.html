{% extends 'page.html' %}

{% block content %}

<h1>{{ object }}</h1>

<div id="cartograph" style="height: 700px"></div>

<link rel="stylesheet" href="/static/js/bower_components/leaflet/dist/leaflet.css" />
<script src="/static/js/bower_components/leaflet/dist/leaflet.js"></script>
<script>
(function() {
    var map = L.map('cartograph'),
        tileURL = 'https://bustimes.org/styles/klokantech-basic/{z}/{x}/{y}' + (L.Browser.retina ? '@2x' : '') + '.png',
        bounds = L.latLngBounds(),
        polyline;
 
    L.tileLayer(tileURL).addTo(map);

    {% for journey in object.get_journeys %}
        {% for location in journey %}
            {% ifchanged location.latlong %}
                L.marker(
                    [{{ location.latlong.y }},{{ location.latlong.x }}]
                ).addTo(map).bindPopup("<p>{{ location.data }}</p>{% if location.service %}<p><a href='{{ location.service.get_absolute.url }}'>{{ location.service }}</a></p>{% endif %}<p>{{ location.datetime }}</p>");
            {% endifchanged %}
        {% endfor %}
        polyline = L.polyline([
            {% for location in journey %}
                 {% ifchanged location.latlong %}
                     [{{ location.latlong.y }},{{ location.latlong.x }}],
                {% endifchanged %}
            {% endfor %}
        ]);
        polyline.addTo(map);
        polyline.bindPopup("{% if journey.0.service %}<p><a href='{{ journey.0.service.get_absolute_url }}'>{{ journey.0.service }}</a></p>{% endif %}<p>{{ journey.0.datetime }}</p>");
        bounds.extend(polyline.getBounds());
    {% endfor %}
    map.fitBounds(bounds);
})();
</script>

{% endblock %}
