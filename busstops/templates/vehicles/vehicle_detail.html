{% extends 'page.html' %}

{% block title %}{% if object.code %}Vehicles – {% endif %}{{ object }} – Bus Times{% endblock %}

{% block canonical %}<meta name="robots" content="noindex, nofollow" />{% endblock %}

{% block content %}

<h1>{{ object }}</h1>

{% if object.vehicle_type %}
    <p>{{ object.vehicle_type }}</p>
{% endif %}

<form>
    <label>
        Date:
        <input type="date" name="date" value={{ date.isoformat }}>
    </label>
    <input type="submit" value="Show">
</form>

<table>
    <tr>
        <th scope="col" colspan="2">Journey</th>
        <th scope="col">To</th>
        <th scope="col">{% if object.region_id %}Vehicle{% else %}Service{% endif %}</th>
    </tr>
{% for journey in journeys %}
    <tr>
        <td>{{ journey.datetime|time }}</td>
        <td>{{ journey.code }}</td>
        <td>{{ journey.destination }}</td>
        <td>
            {% if object.region_id %}
                <a href="{{ journey.vehicle.get_absolute_url }}?date={{ journey.datetime|date:"Y-m-d" }}">{{ journey.vehicle }}</a>
            {% elif journey.service %}
                <a href="{{ journey.service.get_absolute_url }}/vehicles?date={{ journey.datetime|date:"Y-m-d" }}">{{ journey.service.line_name }}</a>
            {% endif %}
        </td>
    </tr>
{% endfor %}
</table>

{% if journeys %}
<div id="cartograph" style="height:80vh"></div>

<link rel="stylesheet" href="/static/js/bower_components/leaflet/dist/leaflet.css" />
<script src="/static/js/bower_components/leaflet/dist/leaflet.js"></script>
<script>
(function() {
    function getRandomColor() {
        var letters = '0123456789';
        var color = '#';
        for (var i = 0; i < 3; i++) {
            color += letters[Math.floor(Math.random() * 10)];
        }
        return color;
    }

    function getMarker(latlng, direction) {
        var html = '';
        if (direction !== null) {
            html = '<div class="arrow" style="-ms-transform: rotate(' + direction + 'deg);-webkit-transform: rotate(' + direction + 'deg);-moz-transform: rotate(' + direction + 'deg);-o-transform: rotate(' + direction + 'deg);transform: rotate(' + direction + 'deg)"></div>';
        }
        return L.marker(latlng, {
            icon: L.divIcon({
                iconSize: [16, 8],
                html: html,
                className: 'just-arrow'
            })
        });
    }

    var map = L.map('cartograph'),
        tileURL = 'https://bustimes.org/styles/klokantech-basic/{z}/{x}/{y}' + (L.Browser.retina ? '@2x' : '') + '.png',
        latlng,
        service,
	bounds = L.latLngBounds();

    L.tileLayer(tileURL).addTo(map);

    {% for journey in journeys %}
        {% if object.region_id %}
            service = '<a href="{{ journey.vehicle.get_absolute_url }}">{{ journey.vehicle }}</a><br>';
        {% else %}
            service = '{% if journey.service %}<a href="{{ journey.service.get_absolute_url }}/vehicles">{{ journey.service.line_name }}</a><br>{% endif %}';
        {% endif %}
        {% for location in journey.vehiclelocation_set.all %}
            latlng = [{{ location.latlong.y }},{{ location.latlong.x }}];
            bounds.extend(latlng);
            getMarker(latlng, {% firstof location.heading 0 %}).bindPopup(service + "{{ location.datetime|time }}").addTo(map);
        {% endfor %}
    {% endfor %}
    map.fitBounds(bounds);
    map.setMaxBounds(bounds.pad(.5));
})();
</script>
{% else %}
    <p>Sorry, nothing found for {{ date }}</p>
{% endif %}

{% endblock %}

{% block ad %}{% endblock %}
