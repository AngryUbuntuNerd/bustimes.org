server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name localhost;

    location / {
        return 301 https://bustimes.org.uk$request_uri;
    }

    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow ::1;
        deny all;
    }
}

server {
    listen 443      deferred ssl http2;
    listen [::]:443 deferred ssl http2;

    server_name bustimes.org.uk;

    index index.html;
    root /home/josh/bustimes-static/;

    include ssl;

    if ($http_host != 'bustimes.org.uk') {
        return 301 https://bustimes.org.uk$request_uri;
    }

    location / {
        add_header strict-transport-security 'max-age=31536000; preload; includeSubDomains' always;
        add_header content-security-policy   "default-src https:; script-src https: 'unsafe-inline'; style-src https: 'unsafe-inline'; img-src https: data:" always;
        add_header X-Frame-Options DENY;
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host            $host;
        proxy_pass http://127.0.0.1:6081;  # varnish
        proxy_max_temp_file_size 0;
    }

    location /htmlcov/ {
        root /home/josh/bustimes.org.uk;
    }

    rewrite ^(.*)&resp_fmts=3$ $1 permanent;

    location /static/ {
        alias /home/josh/bustimes-static/;
        expires 1M;
        add_header 'access-control-allow-origin' 'http://webcache.googleusercontent.com,http://localhost:8000';
    }

    location ~* ^/(favicon.ico$|manifest.json$|rockabox) {
        expires 1M;
        add_header 'access-control-allow-origin' 'http://webcache.googleusercontent.com,http://localhost:8000';
    }

    location /serviceworker.js {
        expires 2d;
    }

    location /.well-known/ {
    }

    location ~* ^/apple-touch-icon(-.+)?.png$ {
        alias /home/josh/bustimes-static/apple-touch-icon.png;
        expires 1M;
    }

    location = /googlee6b1f63032004295.html {
        return 200 'google-site-verification: googlee6b1f63032004295.html';
    }

    location = /robots.txt {
        return 200 'User-agent: *\nDisallow: /admin/\nDisallow: /stops/*/departures';
    }
}

server {
    listen localhost:8080;
    listen [::]:8080;

    server_name bustimes.org.uk;

    access_log off;

    charset utf-8;

    location / {
        proxy_pass http://unix:/home/josh/bustimes.sock;  # gunicorn
        proxy_set_header Host $host;
    }

    set_real_ip_from 127.0.0.1;
    real_ip_header X-Forwarded-For;
}
